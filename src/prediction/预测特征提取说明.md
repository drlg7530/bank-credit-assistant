# 客户贷款金额预测 - 特征提取与模型说明文档

## 一、概述

本文档说明如何使用LightGBM模型预测客户未来n个月的贷款金额，包括数据查询、特征提取、特征工程、模型训练和预测的完整流程。

### 1.1 目标
- 从MySQL数据库查询客户信息
- 提取并构建预测特征
- 训练LightGBM回归模型预测贷款金额
- 使用训练好的模型进行动态预测

### 1.2 数据来源
- **数据库表**: `customer_loan_data`
- **数据库**: MySQL (`bank_credit_agent`)
- **数据字段**: 包含客户基本信息、收入信息、贷款信息、信用历史等

---

## 二、数据库查询

### 2.1 查询模块
**文件位置**: `src/prediction/data_query.py`

### 2.2 主要功能

#### 2.2.1 连接数据库
```python
from src.prediction.data_query import connect_database

connection = connect_database()
```
- 使用配置文件 `config/database.py` 中的数据库连接信息
- 返回数据库连接对象，失败返回None

#### 2.2.2 查询所有客户数据
```python
from src.prediction.data_query import query_all_customers

df = query_all_customers(connection, limit=1000)
```
- **参数**:
  - `connection`: 数据库连接对象
  - `limit`: 限制返回的记录数（可选，None表示返回所有记录）
- **返回**: pandas DataFrame，包含所有客户字段

#### 2.2.3 条件查询
```python
from src.prediction.data_query import query_customers_by_condition

df = query_customers_by_condition(
    connection,
    conditions={'Gender': 'Male', 'Loan_Status': 'Y'},
    limit=100
)
```
- **参数**:
  - `connection`: 数据库连接对象
  - `conditions`: 查询条件字典
  - `limit`: 限制返回的记录数
- **返回**: 符合条件的客户数据DataFrame

#### 2.2.4 数据统计
```python
from src.prediction.data_query import query_customer_statistics

stats = query_customer_statistics(connection)
```
- **返回**: 包含数据统计信息的字典（总记录数、平均值、批准/拒绝数量等）

### 2.3 数据字段说明

| 字段名 | 类型 | 说明 | 取值 |
|--------|------|------|------|
| Loan_ID | VARCHAR(20) | 贷款ID（主键） | 唯一标识符 |
| Gender | VARCHAR(10) | 性别 | Male / Female |
| Married | VARCHAR(10) | 是否已婚 | Yes / No |
| Dependents | VARCHAR(10) | 家属人数 | 0 / 1 / 2 / 3+ |
| Education | VARCHAR(20) | 教育程度 | Graduate / Not Graduate |
| Self_Employed | VARCHAR(10) | 是否自雇 | Yes / No |
| ApplicantIncome | DECIMAL(10,2) | 申请人收入（元） | 数值 |
| CoapplicantIncome | DECIMAL(10,2) | 共同申请人收入（元） | 数值 |
| LoanAmount | DECIMAL(10,2) | 贷款金额（元） | 数值（可为空） |
| Loan_Amount_Term | INT | 贷款期限（天） | 数值 |
| Credit_History | TINYINT | 信用历史 | 0-无记录，1-有记录 |
| Property_Area | VARCHAR(20) | 房产区域 | Urban / Rural / Semiurban |
| Loan_Status | VARCHAR(1) | 贷款状态 | Y-批准，N-拒绝 |
| created_at | TIMESTAMP | 创建时间 | 时间戳 |
| updated_at | DATETIME | 更新时间 | 时间戳 |

---

## 三、特征提取

### 3.1 特征提取模块
**文件位置**: `src/prediction/feature_extraction.py`

### 3.2 特征分类

#### 3.2.1 原始特征（Base Features）
直接从数据库字段获取的数值型特征：

- **ApplicantIncome**: 申请人收入
- **CoapplicantIncome**: 共同申请人收入
- **LoanAmount**: 贷款金额
- **Loan_Amount_Term**: 贷款期限（天）
- **Credit_History**: 信用历史（0/1）

#### 3.2.2 衍生特征（Derived Features）
基于原始特征计算的新特征：

| 特征名 | 计算公式 | 说明 |
|--------|----------|------|
| **TotalIncome** | ApplicantIncome + CoapplicantIncome | 总家庭收入 |
| **LoanToIncomeRatio** | LoanAmount / TotalIncome | 贷款收入比（衡量还款能力） |
| **MonthlyIncome** | TotalIncome / 12 | 月收入 |
| **MonthlyPayment** | LoanAmount / (Loan_Amount_Term / 30) | 月还款额估算 |
| **PaymentToIncomeRatio** | MonthlyPayment / MonthlyIncome | 还款收入比（衡量还款压力） |
| **HasCoapplicant** | CoapplicantIncome > 0 ? 1 : 0 | 是否有共同申请人（二值特征） |
| **IncomeLevel** | 基于TotalIncome的四分位数分类 | 收入水平：Low/Medium/High/VeryHigh |
| **LoanAmountLevel** | 基于LoanAmount的四分位数分类 | 贷款金额水平：Small/Medium/Large/VeryLarge |

#### 3.2.3 编码特征（Encoded Features）
分类特征经过Label Encoding转换后的数值特征：

| 原始特征 | 编码特征 | 类别数 | 说明 |
|----------|----------|--------|------|
| Gender | Gender_encoded | 2 | 性别编码 |
| Married | Married_encoded | 2 | 婚姻状况编码 |
| Dependents | Dependents_encoded | 4 | 家属人数编码（0/1/2/3+） |
| Education | Education_encoded | 2 | 教育程度编码 |
| Self_Employed | Self_Employed_encoded | 2 | 是否自雇编码 |
| Property_Area | Property_Area_encoded | 3 | 房产区域编码 |
| IncomeLevel | IncomeLevel_encoded | 4 | 收入水平编码 |
| LoanAmountLevel | LoanAmountLevel_encoded | 4 | 贷款金额水平编码 |

### 3.3 特征提取流程

#### 步骤1: 数据查询
```python
from src.prediction.data_query import connect_database, query_all_customers

connection = connect_database()
df_raw = query_all_customers(connection, limit=1000)
```

#### 步骤2: 缺失值处理
- **数值型字段**: 用中位数填充
- **分类型字段**: 用众数填充

```python
from src.prediction.feature_extraction import handle_missing_values

df_processed = handle_missing_values(df_raw)
```

#### 步骤3: 创建衍生特征
```python
from src.prediction.feature_extraction import create_derived_features

df_features = create_derived_features(df_processed)
```

#### 步骤4: 编码分类特征
```python
from src.prediction.feature_extraction import encode_categorical_features

df_encoded, encoders = encode_categorical_features(df_features)
```

#### 步骤5: 选择训练特征
```python
from src.prediction.feature_extraction import select_features_for_training

X = select_features_for_training(df_encoded)
```

#### 步骤6: 提取标签（用于训练）
```python
# 对于贷款金额预测，标签是LoanAmount（回归问题）
y = df_encoded['LoanAmount']
```

### 3.4 完整特征提取示例

```python
from src.prediction.data_query import connect_database
from src.prediction.feature_extraction import extract_features_from_database

# 连接数据库
connection = connect_database()

# 提取特征（包含标签）
X, y, encoders = extract_features_from_database(
    connection,
    limit=1000,
    include_label=True
)

# X: 特征DataFrame (n_samples, n_features)
# y: 标签Series (n_samples,)
# encoders: 编码器字典，用于后续预测时的特征编码

connection.close()
```

---

## 四、特征说明

### 4.1 特征重要性分析

#### 高重要性特征（预期）
1. **Credit_History**: 信用历史是贷款审批的关键因素
2. **LoanToIncomeRatio**: 贷款收入比反映还款能力
3. **PaymentToIncomeRatio**: 还款收入比反映还款压力
4. **TotalIncome**: 总收入反映客户经济实力
5. **LoanAmount**: 贷款金额影响风险等级

#### 中等重要性特征（预期）
1. **Education**: 教育程度与收入稳定性相关
2. **Property_Area**: 房产区域反映经济环境
3. **HasCoapplicant**: 共同申请人增加还款保障
4. **Married**: 婚姻状况影响家庭稳定性

#### 低重要性特征（预期）
1. **Gender**: 性别对贷款意向影响较小
2. **Self_Employed**: 自雇状态（可能影响收入稳定性）

### 4.2 特征工程建议

#### 4.2.1 特征选择
- 使用LightGBM的特征重要性自动选择重要特征
- 可以移除重要性极低的特征以减少过拟合风险

#### 4.2.2 特征缩放
- LightGBM基于树模型，**不需要**特征标准化
- 但可以尝试特征归一化观察效果

#### 4.2.3 特征交互
- 可以创建特征交互项，如：
  - `IncomeLevel × Credit_History`
  - `LoanToIncomeRatio × Property_Area_encoded`
- LightGBM会自动学习特征交互，但显式特征可能有助于提升效果

#### 4.2.4 时间特征（未来扩展）
如果数据包含时间信息，可以提取：
- 申请月份、季度
- 距离上次申请的时间间隔
- 季节性特征

---

## 五、数据质量检查

### 5.1 缺失值检查
```python
# 检查缺失值比例
missing_ratio = df.isnull().sum() / len(df)
print(missing_ratio[missing_ratio > 0])
```

### 5.2 异常值检查
```python
# 检查数值特征的异常值（使用IQR方法）
numeric_cols = ['ApplicantIncome', 'CoapplicantIncome', 'LoanAmount']
for col in numeric_cols:
    Q1 = df[col].quantile(0.25)
    Q3 = df[col].quantile(0.75)
    IQR = Q3 - Q1
    outliers = df[(df[col] < Q1 - 1.5*IQR) | (df[col] > Q3 + 1.5*IQR)]
    print(f"{col} 异常值数量: {len(outliers)}")
```

### 5.3 数据分布检查
```python
# 检查标签分布（类别不平衡）
print(y.value_counts())
print(f"正样本比例: {y.mean():.2%}")
```

---

## 六、使用示例

### 6.1 完整流程示例

```python
"""
完整的特征提取流程示例
"""
import sys
from pathlib import Path

# 添加项目根目录到路径
project_root = Path(__file__).parent.parent.parent
sys.path.insert(0, str(project_root))

from src.prediction.data_query import connect_database
from src.prediction.feature_extraction import extract_features_from_database, save_features

# 1. 连接数据库
connection = connect_database()
if not connection:
    print("数据库连接失败")
    exit(1)

try:
    # 2. 提取特征
    X, y, encoders = extract_features_from_database(
        connection,
        limit=None,  # 查询所有数据
        include_label=True
    )
    
    # 3. 检查特征
    print(f"特征形状: {X.shape}")
    print(f"特征列: {list(X.columns)}")
    print(f"标签分布:\n{y.value_counts()}")
    
    # 4. 保存特征
    output_dir = project_root / 'data' / 'prediction'
    save_features(X, y, str(output_dir))
    
    print("特征提取完成！")
    
finally:
    connection.close()
```

### 6.2 单独使用查询功能

```python
from src.prediction.data_query import (
    connect_database,
    query_all_customers,
    query_customer_statistics
)

connection = connect_database()

# 查询统计信息
stats = query_customer_statistics(connection)
print(f"总记录数: {stats['total']}")
print(f"平均收入: {stats['avg_applicant_income']:.2f}")

# 查询数据
df = query_all_customers(connection, limit=100)
print(f"查询到 {len(df)} 条记录")

connection.close()
```

---

## 七、输出文件

### 7.1 特征文件
- **位置**: `data/prediction/features.csv`
- **格式**: CSV文件，每行一个样本，每列一个特征
- **编码**: UTF-8 with BOM（支持Excel打开）

### 7.2 标签文件
- **位置**: `data/prediction/labels.csv`
- **格式**: CSV文件，单列标签（1=批准，0=拒绝）
- **编码**: UTF-8 with BOM

### 7.3 日志文件
- **位置**: `logs/feature_extraction.log`
- **内容**: 特征提取过程的详细日志

---

## 八、注意事项

### 8.1 数据隐私
- 所有客户数据均为模拟/脱敏数据
- 不包含真实客户敏感信息
- 仅用于演示和模型训练

### 8.2 特征一致性
- 训练和预测时使用相同的特征提取流程
- 保存编码器（encoders）用于预测时的特征编码
- 确保缺失值处理方式一致

### 8.3 特征更新
- 如果数据库字段发生变化，需要同步更新特征提取逻辑
- 新增特征需要重新训练模型

### 8.4 性能优化
- 大数据量时使用批量查询（limit参数）
- 特征提取可以并行化处理
- 考虑使用特征缓存机制

---

## 九、模型训练与预测

### 9.1 模型训练模块
**文件位置**: `src/prediction/model_train.py`

#### 9.1.1 训练流程
1. **数据划分**: 将数据分为训练集、验证集、测试集
2. **模型训练**: 使用LightGBM训练回归模型（预测LoanAmount）
3. **模型评估**: 评估模型性能（MAE、RMSE、R²等）
4. **特征重要性**: 分析特征重要性，优化特征工程
5. **模型保存**: 将训练好的模型和编码器保存，用于预测

#### 9.1.2 训练示例
```python
from src.prediction.model_train import train_loan_amount_model

# 训练模型
model, encoders, feature_names, metrics = train_loan_amount_model(
    connection,
    test_size=0.2,
    random_state=42
)
```

### 9.2 模型预测测试模块
**文件位置**: `src/prediction/model_predict_test.py`

#### 9.2.1 预测流程
1. **加载模型**: 加载训练好的LightGBM模型和编码器
2. **特征提取**: 从客户数据提取特征（使用相同的特征工程流程）
3. **特征编码**: 使用保存的编码器对分类特征进行编码
4. **模型预测**: 使用模型预测贷款金额

#### 9.2.2 预测测试示例
```python
from src.prediction.model_predict_test import predict_loan_amount

# 预测单个客户的贷款金额
customer_data = {
    'Gender': 'Male',
    'Married': 'Yes',
    'ApplicantIncome': 5000,
    # ... 其他特征
}
predicted_amount = predict_loan_amount(customer_data, months_ahead=6)
```

**注意**: `model_predict_test.py` 是测试脚本，用于验证预测功能。实际系统集成时，应使用模块中的函数而非直接运行此脚本。

---

## 十、常见问题

### Q1: 如何处理缺失值？
**A**: 数值型字段用中位数填充，分类型字段用众数填充。也可以根据业务逻辑自定义填充策略。

### Q2: 为什么使用Label Encoding而不是One-Hot Encoding？
**A**: LightGBM可以处理类别特征，Label Encoding更节省空间。如果类别数较少，也可以尝试One-Hot Encoding。

### Q3: 特征数量是多少？
**A**: 最终特征数量约为21个（5个原始特征 + 8个衍生特征 + 8个编码特征）。

### Q4: 如何添加新特征？
**A**: 在 `create_derived_features()` 函数中添加新特征的计算逻辑，然后在 `select_features_for_training()` 中将新特征加入特征列表。

### Q5: 预测时如何使用这些特征？
**A**: 预测时需要：
1. 使用相同的特征提取流程
2. 使用训练时保存的编码器（encoders）进行特征编码
3. 确保特征顺序与训练时一致

---

## 十一、参考资源

- **LightGBM官方文档**: https://lightgbm.readthedocs.io/
- **特征工程最佳实践**: https://www.kaggle.com/learn/feature-engineering
- **项目代码**: `src/prediction/feature_extraction.py`

---

**文档版本**: v1.1  
**最后更新**: 2025-01-XX  
**维护者**: 项目开发团队

